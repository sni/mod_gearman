<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.0.0rc2" />
<title>Naemon Gearman Module</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>

</head>
<body class="article" style="max-width:800">
<div id="header">
<h1>Naemon Gearman Module</h1>
<div id="toc"><div id="toctitle">Table of Contents</div>
<div class='toclevel1'><a href='#_what_is_mod_gearman'>What is Mod-Gearman</a></div>
<div class='toclevel1'><a href='#_presentations'>Presentations</a></div>
<div class='toclevel1'><a href='#_features'>Features</a></div>
<div class='toclevel1'><a href='#_download'>Download</a></div>
<div class='toclevel1'><a href='#_support'>Support</a></div>
<div class='toclevel1'><a href='#_changelog'>Changelog</a></div>
<div class='toclevel1'><a href='#_how_does_it_work'>How does it work</a></div>
<div class='toclevel1'><a href='#_common_scenarios'>Common Scenarios</a></div>
<div class='toclevel2'><a href='#_load_balancing'>Load Balancing</a></div>
<div class='toclevel2'><a href='#_distributed_monitoring'>Distributed Monitoring</a></div>
<div class='toclevel2'><a href='#_distributed_monitoring_with_load_balancing'>Distributed Monitoring with Load Balancing</a></div>
<div class='toclevel2'><a href='#_nsca_replacement'>NSCA Replacement</a></div>
<div class='toclevel2'><a href='#_distributed_setup_with_remote_scheduler'>Distributed Setup With Remote Scheduler</a></div>
<div class='toclevel2'><a href='#_gearman_proxy'>Gearman Proxy</a></div>
<div class='toclevel1'><a href='#_installation'>Installation</a></div>
<div class='toclevel2'><a href='#_omd'>OMD</a></div>
<div class='toclevel2'><a href='#_debian_ubuntu'>Debian / Ubuntu</a></div>
<div class='toclevel2'><a href='#_centos_redhat'>Centos/Redhat</a></div>
<div class='toclevel2'><a href='#_from_source'>From Source</a></div>
<div class='toclevel1'><a href='#_configuration'>Configuration</a></div>
<div class='toclevel2'><a href='#_naemon_core'>Naemon Core</a></div>
<div class='toclevel2'><a href='#_common_options'>Common Options</a></div>
<div class='toclevel2'><a href='#_server_options'>Server Options</a></div>
<div class='toclevel2'><a href='#_worker_options'>Worker Options</a></div>
<div class='toclevel1'><a href='#_queue_names'>Queue Names</a></div>
<div class='toclevel1'><a href='#_performance'>Performance</a></div>
<div class='toclevel1'><a href='#_exports'>Exports</a></div>
<div class='toclevel1'><a href='#_embedded_perl'>Embedded Perl</a></div>
<div class='toclevel1'><a href='#_how_to'>How To</a></div>
<div class='toclevel2'><a href='#_how_to_monitor_job_server_and_worker'>How to Monitor Job Server and Worker</a></div>
<div class='toclevel2'><a href='#_how_to_submit_passive_checks'>How to Submit Passive Checks</a></div>
<div class='toclevel2'><a href='#_how_to_build_send_gearman_exe'>How to build send_gearman.exe</a></div>
<div class='toclevel2'><a href='#_how_to_submit_check_multi_results'>How to Submit check_multi Results</a></div>
<div class='toclevel2'><a href='#_how_to_set_queue_by_custom_variable'>How to Set Queue by Custom Variable</a></div>
<div class='toclevel1'><a href='#_notifications'>Notifications</a></div>
<div class='toclevel1'><a href='#_supported_dependencies'>Supported Dependencies</a></div>
<div class='toclevel2'><a href='#_lib_gearman'>Lib-Gearman</a></div>
<div class='toclevel2'><a href='#_naemon'>Naemon</a></div>
<div class='toclevel2'><a href='#_nagios'>Nagios</a></div>
<div class='toclevel2'><a href='#_icinga'>Icinga</a></div>
<div class='toclevel1'><a href='#_hints'>Hints</a></div>
</div>

</div>
<div id="content">
<div class="sect1">
<h2 id="_what_is_mod_gearman">What is Mod-Gearman</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://labs.consol.de/nagios/mod-gearman">Mod_Gearman</a> is an easy way
of distributing active Naemon checks across your network and
increasing Naemon scalability. Mod-Gearman can even help to reduce the
load on a single Naemon host, because its much smaller and more
efficient in executing checks.</p></div>
<div class="ulist"><ul>
<li>
<p>
Mod-Gearman 4.x works with <a href="https://www.naemon.io">Naemon Core</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>It consists of three parts:</p></div>
<div class="ulist"><ul>
<li>
<p>
There is a NEB module which resides in the Naemon core and adds servicechecks,
   hostchecks and eventhandler to a Gearman queue.
</p>
</li>
<li>
<p>
The counterpart is one or more worker clients executing the checks.
   Worker can be configured to only run checks for specific host- or
   servicegroups.
   There is a (deprecated) worker included. The new worker is here:
   <a href="https://github.com/ConSol/mod-gearman-worker-go/">mod-gearman-worker-go</a>.
</p>
</li>
<li>
<p>
And you need at least one <a href="http://gearman.org">Gearman Job Server</a>
   running.
</p>
</li>
<li>
<p>
See the <a href="#common-scenarios">common scenarios</a> for some examples.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_presentations">Presentations</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
<a href="http://mod-gearman.org/slides/Mod-Gearman-2012-10-18.pdf">Monitoring Conference 2012 in Nürnberg</a>
</p>
</li>
<li>
<p>
<a href="http://mod-gearman.org/slides/Mod-Gearman-2011-05-24.pdf">Nagios Workshop 2011 in Hannover</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_features">Features</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Reduce load of your central Naemon machine
</p>
</li>
<li>
<p>
Make Naemon scalable up to thousands of checks per second
</p>
</li>
<li>
<p>
Easy distributed setups without configuration overhead
</p>
</li>
<li>
<p>
Real loadbalancing across all workers
</p>
</li>
<li>
<p>
Real failover for redundant workers
</p>
</li>
<li>
<p>
Embedded Perl support for very fast execution of perl scripts
</p>
</li>
<li>
<p>
Fast transport of passive check results with included tools like
   send_gearman and send_multi
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_download">Download</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Latest stable release <a href="http://www.mod-gearman.org/download/v3.0.5/src/mod_gearman-3.0.5.tar.gz">version 3.0.5</a>, released Jul 10 2017
</p>
</li>
<li>
<p>
Mod Gearman is available for download at: <a href="http://mod-gearman.org/download.html">http://mod-gearman.org/download.html</a>
</p>
</li>
<li>
<p>
Source is available on GitHub: <a href="http://github.com/sni/mod_gearman">http://github.com/sni/mod_gearman</a>
</p>
</li>
<li>
<p>
Older versions are available in the <a href="#_archive">download archive</a>.
</p>
</li>
<li>
<p>
Mod-Gearman is also included in <a href="http://omdistro.org">OMD</a>.
</p>
</li>
<li>
<p>
Debian users should use the <a href="http://packages.debian.org/source/wheezy/mod-gearman">official packages</a>
</p>
</li>
<li>
<p>
SLES/RHEL/Centos users should use the <a href="http://mod-gearman.org/download/">prebuild packages</a>
</p>
</li>
<li>
<p>
Debian/Ubuntu users might also want to check out the <a href="http://mod-gearman.org/download/">unoffical packages</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_support">Support</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Professional support and consulting is available via <a href="http://www.consol.de/open-source-monitoring/support/">www.consol.de</a>
</p>
</li>
<li>
<p>
<a href="https://groups.google.com/group/mod_gearman">google groups mailinglist</a>
</p>
</li>
<li>
<p>
<a href="http://www.monitoring-portal.org">german monitoring portal</a>
</p>
</li>
<li>
<p>
Mod-Gearman has been succesfully tested with latest Naemon.
   See <a href="#supported-dependencies">Supported Dependencies</a> for details.
</p>
</li>
<li>
<p>
There are no known bugs at the moment. Let me know if you find one.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_changelog">Changelog</h2>
<div class="sectionbody">
<div class="paragraph"><p>The changelog is available on
<a href="https://github.com/sni/mod_gearman/blob/master/Changes">github</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_does_it_work">How does it work</h2>
<div class="sectionbody">
<div class="paragraph"><p>When the Mod-Gearman broker module is loaded, it intercepts all
servicechecks, hostchecks and the eventhandler events. Eventhandler
are then sent to a generic <em>eventhandler</em> queue. Checks for hosts
which are in one of the specified hostgroups, are sent into a seperate
hostgroup queue. All non matching hosts are sent to a generic <em>hosts</em>
queue.  Checks for services are first checked against the list of
servicegroups, then against the hostgroups and if none matches they
will be sent into a generic <em>service</em> queue. The NEB module starts a
single thread, which monitors the <em>check_results</em> where all results
come in.</p></div>
<a title="mod gearman architecture" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/mod_gearman-e1284455350110.png"><img src="http://labs.consol.de/nagios/mod-gearman/mod_gearman-e1284455350110.png" alt="mod_gearman architecture" width="480" height="300" style="float:none" /></a>
<div class="paragraph"><p>A simple example queue would look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+---------------+------------------+--------------+--------------+
| Queue Name    | Worker Available | Jobs Waiting | Jobs Running |
+---------------+------------------+--------------+--------------+
| check_results | 1                | 0            | 0            |
| eventhandler  | 50               | 0            | 0            |
| host          | 50               | 0            | 1            |
| service       | 50               | 0            | 13           |
+---------------+------------------+--------------+--------------+</code></pre>
</div></div>
<div class="paragraph"><p>There is one queue for the results and two for the checks plus the
eventhandler queue.</p></div>
<div class="paragraph"><p>The workflow is simple:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Naemon wants to execute a service check.
</p>
</li>
<li>
<p>
The check is intercepted by the Mod-Gearman neb module.
</p>
</li>
<li>
<p>
Mod-Gearman puts the job into the <em>service</em> queue.
</p>
</li>
<li>
<p>
A worker grabs the job and puts back the result into the
    <em>check_results</em> queue
</p>
</li>
<li>
<p>
Mod-Gearman grabs the result job and puts back the result onto the
    check result list
</p>
</li>
<li>
<p>
The Naemon reaper reads all checks from the result list and
    updates hosts and services
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can set some host or servicegroups for special worker. This
example uses a seperate hostgroup for Japan and a seperate
servicegroup for resource intensive selenium checks.</p></div>
<div class="paragraph"><p>It would look like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+-----------------------+------------------+--------------+--------------+
| Queue Name            | Worker Available | Jobs Waiting | Jobs Running |
+-----------------------+------------------+--------------+--------------+
| check_results         | 1                | 0            | 0            |
| eventhandler          | 50               | 0            | 0            |
| host                  | 50               | 0            | 1            |
| hostgroup_japan       | 3                | 1            | 3            |
| service               | 50               | 0            | 13           |
| servicegroup_selenium | 2                | 0            | 2            |
+-----------------------+------------------+--------------+--------------+</code></pre>
</div></div>
<div class="paragraph"><p>You still have the generic queues and in addition there are two queues
for the specific groups.</p></div>
<div class="paragraph"><p>The worker processes will take jobs from the queues and put the result
back into the check_result queue which will then be taken back by the
neb module and put back into the Naemon core. A worker can work on one
or more queues. So you could start a worker which only handles the
<em>hostgroup_japan</em> group.  One worker for the <em>selenium</em> checks and one
worker which covers the other queues. There can be more than one
worker on each queue to share the load.</p></div>
<a title="mod gearman queues" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/mod_gearman_queues.png"><img src="http://labs.consol.de/nagios/mod-gearman/mod_gearman_queues.png" alt="mod_gearman architecture " width="360" height="270" style="float:none" /></a>
</div>
</div>
<div class="sect1">
<h2 id="_common_scenarios">Common Scenarios</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_load_balancing">Load Balancing</h3>
<a title="Load Balancing" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/sample_load_balancing.png"><img src="http://labs.consol.de/nagios/mod-gearman/sample_load_balancing.png" alt="Load Balancing" width="300" height="125" style="float:none" /></a>
<div class="paragraph"><p>The easiest variant is a simple load balancing. For example if your
single Naemon box just cannot handle the load, you could just add a
worker in the same network (or even on the same host) to reduce your
load on the Naemon box. Therefor we just enable hosts, services and
eventhandler on the server and the worker.</p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
reduced load on your monitoring box
</p>
</li>
</ul></div>
<div class="paragraph"><p>Contra:</p></div>
<div class="ulist"><ul>
<li>
<p>
no failover
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_distributed_monitoring">Distributed Monitoring</h3>
<a title="Distributed Monitoring" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/sample_distributed.png"><img src="http://labs.consol.de/nagios/mod-gearman/sample_distributed.png" alt="Distributed Monitoring" width="350" height="125" style="float:none" /></a>
<div class="paragraph"><p>If your checks have to be run from different network segments, then
you can use the hostgroups (or servicegroups) to define a hostgroup
for specific worker. The general hosts and services queue is disabled
for this worker and just the hosts and services from the given
hostgroup will be processed.</p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
reduced load on your monitoring box
</p>
</li>
<li>
<p>
ability to access remote networks
</p>
</li>
</ul></div>
<div class="paragraph"><p>Contra:</p></div>
<div class="ulist"><ul>
<li>
<p>
no failover
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_distributed_monitoring_with_load_balancing">Distributed Monitoring with Load Balancing</h3>
<a title="Distributed Monitoring with Load Balancing" rel="lightbox[mod_gm]"
href="http://labs.consol.de/nagios/mod-gearman/sample_distributed_load_balanced.png"><img
src="http://labs.consol.de/nagios/mod-gearman/sample_distributed_load_balanced.png" alt="Distributed Monitoring with Load Balancing" width="350" height="225" style="float:none" /></a>
<div class="paragraph"><p>Your distributed setup could easily be extended to a load balanced
setup with just adding more worker of the same config.</p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
reduced load on your monitoring box
</p>
</li>
<li>
<p>
ability to access remote networks
</p>
</li>
<li>
<p>
automatic failover and load balancing for worker
</p>
</li>
</ul></div>
<div class="paragraph"><p>Contra:</p></div>
<div class="ulist"><ul>
<li>
<p>
no failover for the master
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_nsca_replacement">NSCA Replacement</h3>
<a title="NSCA Replacement" rel="lightbox[mod_gm]"
href="http://labs.consol.de/nagios/mod-gearman/nsca_replacement.png"><img
src="http://labs.consol.de/nagios/mod-gearman/nsca_replacement.png" alt="NSCA Replacement" width="300" height="220" style="float:none" /></a>
<div class="paragraph"><p>If you just want to replace a current NSCA solution, you could load
the Mod-Gearman NEB module and disable all distribution features. You
still can receive passive results by the core send via
send_gearman / send_multi. Make sure you use the same encryption
settings like the neb module or your core won&#8217;t be able to process the
results or use the <em>accept_clear_results</em> option.</p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
easy to setup in existing environments
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_distributed_setup_with_remote_scheduler">Distributed Setup With Remote Scheduler</h3>
<a title="Distributed Setup With Remote Scheduler" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/advanced_distributed.png"><img src="http://labs.consol.de/nagios/mod-gearman/advanced_distributed.png" alt="Distributed Setup With Remote Scheduler" width="360" height="270" style="float:none" /></a>
<div class="paragraph"><p>In case your network is unstable or you need a gui view from the
remote location or any other reason which makes a remote core
unavoidable you may want this setup. Thist setup consists of 2
independent Mod-Gearman setups and the slave worker just send their
results to the master via the <em>dup_server</em> option. The master
objects configuration must contain all slave services and hosts.
The configuration sync is not part of Mod-Gearman.</p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
independent from network outtakes
</p>
</li>
<li>
<p>
local view
</p>
</li>
</ul></div>
<div class="paragraph"><p>Contra:</p></div>
<div class="ulist"><ul>
<li>
<p>
more complex setup
</p>
</li>
<li>
<p>
requires configuration sync
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_gearman_proxy">Gearman Proxy</h3>
<a title="Gearman Proxy" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/gearman_proxy.png"><img src="http://labs.consol.de/nagios/mod-gearman/gearman_proxy.png" alt="Gearman Proxy" width="360" height="270" style="float:none" /></a>
<div class="paragraph"><p>Sometimes you may need to reverse the direction of the initial
connection attempt. Usually the worker and the neb module open the
initial connection so they need to access the gearmand port. In cases
where no direct connection is possible use ssh tunnel or the Gearman
proxy. The Gearman proxy just puts jobs from one gearmand into another
gearmand and vice versa.</p></div>
<div class="paragraph"><p>gearman_proxy.pl can be found at <a href="https://github.com/sni/gearman-proxy">https://github.com/sni/gearman-proxy</a></p></div>
<div class="paragraph"><p>Pro:</p></div>
<div class="ulist"><ul>
<li>
<p>
changes direction of initial connection setup
</p>
</li>
<li>
<p>
buffers network outages
</p>
</li>
</ul></div>
<div class="paragraph"><p>Contra:</p></div>
<div class="ulist"><ul>
<li>
<p>
two more daemon to monitor and maintain
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_omd">OMD</h3>
<div class="paragraph"><p>Using OMD is propably the easiest way of installing and using
Mod-Gearman. You just have to run <em>omd config</em> or set Mod-Gearman
to <em>on</em>.</p></div>
<div class="paragraph"><p>OMD is available for Debian, Ubuntu, Centos/Redhat and SLES.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>OMD[test]:~$ omd config set MOD_GEARMAN on</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Mod-Gearman is included in <a href="http://omdistro.org">OMD</a> since version 0.48.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_debian_ubuntu">Debian / Ubuntu</h3>
<div class="paragraph"><p>It is strongly recommended to use the
<a href="http://packages.debian.org/source/wheezy/mod-gearman">official
packages</a> or the <a href="http://mod-gearman.org/download/">unoffical packages</a> which
contains Debian Squeeze and various Ubuntu packages.</p></div>
</div>
<div class="sect2">
<h3 id="_centos_redhat">Centos/Redhat</h3>
<div class="paragraph"><p>The easy and proper way is to build RPM packages. The following steps
assume a Centos 5.7. Other releases may have different versions but
should behave similar.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">use the <a href="http://mod-gearman.org/download/">prebuild packages</a> if
available.</td>
</tr></table>
</div>
<div class="paragraph"><p>Build/install Gearmand rpms</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#&gt; yum install autoconf automake libtool boost141-devel boost141-program-options
#&gt; cd /tmp
#&gt; wget http://launchpad.net/gearmand/trunk/0.33/+download/gearmand-0.33.tar.gz
#&gt; tar zxf gearmand-0.33.tar.gz
#&gt; ln -s gearmand-0.33/support/gearmand.init /tmp/gearmand.init
#&gt; vi gearmand-0.33/support/gearmand.spec
   change in line 9 and 25:
   Requires: sqlite, libevent &gt;= 1.4, boost-program-options &gt;=  1.39
   in
   Requires: sqlite, libevent &gt;= 1.4, boost141-program-options &gt;=  1.39
#&gt; tar cfz gearmand-0.33.tar.gz gearmand-0.33
#&gt; LIBRARY_PATH=/usr/lib64/boost141:/usr/lib/boost141 \
   LD_LIBRARY_PATH=/usr/lib64/boost141:/usr/lib/boost141 \
   CPATH=/usr/include/boost141 \
   rpmbuild -tb gearmand-0.33.tar.gz
#&gt; yum --nogpgcheck install /usr/src/redhat/RPMS/*/gearmand*-0.33-1*.rpm</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The link to gearmand.init is a workaround, otherwise the build
will fail. It may not be necessary for future gearman versions.</td>
</tr></table>
</div>
<div class="paragraph"><p>Build/install Mod-Gearman rpms</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#&gt; wget http://mod-gearman.org/download/v1.5.2/src/mod_gearman-1.5.2.tar.gz
#&gt; rpmbuild -tb mod_gearman-1.5.2.tar.gz
#&gt; yum --nogpgcheck install /usr/src/redhat/RPMS/*/mod_gearman-1.5.2-1.*.rpm</code></pre>
</div></div>
<div class="paragraph"><p>Finally start and check your installation</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#&gt; /etc/init.d/gearmand start
#&gt; /etc/init.d/mod_gearman_worker start
#&gt; gearman_top</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_from_source">From Source</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">source installation should be avoided if possible. Prebuild packages are way easier to maintain.</td>
</tr></table>
</div>
<div class="paragraph"><p>Pre Requirements:</p></div>
<div class="ulist"><ul>
<li>
<p>
gcc / g++
</p>
</li>
<li>
<p>
autoconf / automake / autoheader
</p>
</li>
<li>
<p>
libtool
</p>
</li>
<li>
<p>
libgearman (&gt;= 0.14)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Download the tarball and perform the following steps:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#&gt; ./autogen.sh        # only required when installing from git
#&gt; ./configure
#&gt; make
#&gt; make install</code></pre>
</div></div>
<div class="paragraph"><p>Then add the mod_gearman_naemon.o to your Naemon installation and add a
broker line to your naemon.cfg:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>broker_module=.../mod_gearman_naemon.o server=localhost:4730 eventhandler=yes services=yes hosts=yes config=.../module.conf</code></pre>
</div></div>
<div class="paragraph"><p>see <a href="#_configuration">Configuration</a> for details on all parameters</p></div>
<div class="paragraph"><p>The next step is to start one or more worker. You may use the same
configuration file as for the neb module.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>./mod_gearman_worker --server=localhost:4730 --services --hosts</code></pre>
</div></div>
<div class="paragraph"><p>or use the supplied init script.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Make sure you have started your Gearmand job server. Usually
it can be started with</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content">
<pre><code>/usr/sbin/gearmand -t 10 -j 0</code></pre>
</div></div>
<div class="paragraph"><p>or a supplied init script. Command line
arguments have change in recent gearman versions and you now should
use something like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>/usr/sbin/gearmand --threads=10 --job-retries=0</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_naemon_core">Naemon Core</h3>
<div class="paragraph"><p>A sample broker in your naemon.cfg could look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>broker_module=/usr/local/share/naemon/mod_gearman_naemon.o keyfile=/usr/local/share/naemon/secret.txt server=localhost eventhandler=yes hosts=yes services=yes config=.../module.conf</code></pre>
</div></div>
<div class="paragraph"><p>See the following list for a detailed explanation of available
options:</p></div>
</div>
<div class="sect2">
<h3 id="_common_options">Common Options</h3>
<div class="paragraph"><p>Shared options for worker and the NEB module:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
config
</dt>
<dd>
<p>
    include config from this file. Options are the same as described here.
    <em>include</em> is an alias for <em>config</em>.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>config=/etc/naemon/mod_gm_worker.conf</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
debug
</dt>
<dd>
<p>
    use debug to increase the verbosity of the module.
    Possible values are:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<code>0</code>   - only errors
</p>
</li>
<li>
<p>
<code>1-4</code> - debug verbosity
</p>
</li>
<li>
<p>
<code>5</code>   - trace and all gearman related logs are going to stdout
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Default is 0.</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>debug=1</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
logmode
</dt>
<dd>
<p>
    set way of logging.
    Possible values are:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<code>automatic</code> - logfile when a logfile is specified. stdout when
                    no logfile is given.
                    stdout for tools.
</p>
</li>
<li>
<p>
<code>stdout</code>    - just print all messages to stdout
</p>
</li>
<li>
<p>
<code>syslog</code>    - use syslog for all log events
</p>
</li>
<li>
<p>
<code>file</code>      - use logfile
</p>
</li>
<li>
<p>
<code>core</code>      - use naemon internal loging (not thread safe! Use
                    with care)
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Default is automatic.</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>logmode=automatic</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
logfile
</dt>
<dd>
<p>
Path to the logfile.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>logfile=/path/to/log.file</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
server
</dt>
<dd>
<p>
sets the address of your gearman job server. Can be specified
more than once to add more server. Mod-Gearman uses
the first server available.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>server=localhost:4730,remote_host:4730</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
eventhandler
</dt>
<dd>
<p>
defines if the module should distribute execution of
eventhandlers.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>eventhandler=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
services
</dt>
<dd>
<p>
defines if the module should distribute execution of service checks.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>services=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
hosts
</dt>
<dd>
<p>
defines if the module should distribute execution of host checks.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>hosts=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
hostgroups
</dt>
<dd>
<p>
sets a list of hostgroups which will go into seperate queues.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>hostgroups=name1,name2,name3</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
servicegroups
</dt>
<dd>
<p>
sets a list of servicegroups which will go into seperate queues.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>servicegroups=name1,name2,name3</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
encryption
</dt>
<dd>
<p>
enables or disables encryption. It is strongly advised to not disable
encryption. Anybody will be able to inject packages to your worker. Encryption
is enabled by default and you have to explicitly disable it. When using
encryption, you will either have to specify a shared password with <code>key=...</code> or
a keyfile with <code>keyfile=...</code>.
Default is On.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>encryption=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
key
</dt>
<dd>
<p>
A shared password which will be used for encryption of data pakets. Should be at
least 8 bytes long. Maximum length is 32 characters.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>key=secret</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
keyfile
</dt>
<dd>
<p>
The shared password will be read from this file. Use either key or keyfile.
Only the first 32 characters from the first line will be used.
Whitespace to the right will be trimmed.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>keyfile=/path/to/secret.file</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
use_uniq_jobs
</dt>
<dd>
<p>
Using uniq keys prevents the gearman queues from filling up when there
is no worker. However, gearmand seems to have problems with the uniq
key and sometimes jobs get stuck in the queue. Set this option to <em>off</em>
when you run into problems with stuck jobs but make sure your worker
are running.
Default is On.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>+</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>use_uniq_jobs=on</code></pre>
</div></div>
</div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
gearman_connection_timeout
</dt>
<dd>
<p>
Timeout in milliseconds when connecting to gearmand daemon. Set to 0 to disable
the timeout.
Default is 5000.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>+</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>gearman_connection_timeout=5000</code></pre>
</div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_server_options">Server Options</h3>
<div class="paragraph"><p>Additional options for the NEB module only:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
localhostgroups
</dt>
<dd>
<p>
sets a list of hostgroups which will not be executed by gearman. They are just
passed through.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>localhostgroups=name1,name2,name3</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
localservicegroups
</dt>
<dd>
<p>
sets a list of servicegroups which will not be executed by gearman. They are
just passed through.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>localservicegroups=name1,name2,name3</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
queue_custom_variable
</dt>
<dd>
<p>
Can be used to define the target queue by a custom variable in
addition to host/servicegroups. When set for ex. to <em>WORKER</em> you then
could define a <em>_WORKER</em> custom variable for your hosts and services
to directly set the worker queue. The host queue is inherited unless
overwritten by a service custom variable. Set the value of your custom
variable to <em>local</em> to bypass Mod-Gearman (Same behaviour as in
localhostgroups/localservicegroups).
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>queue_custom_variable=WORKER</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
do_hostchecks
</dt>
<dd>
<p>
Set this to <em>no</em> if you want Mod-Gearman to only take care of
servicechecks. No hostchecks will be processed by Mod-Gearman. Use
this option to disable hostchecks and still have the possibility to
use hostgroups for easy configuration of your services.
If set to yes, you still have to define which hostchecks should be
processed by either using <em>hosts</em> or the <em>hostgroups</em> option.
Default: <code>yes</code>
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>do_hostchecks=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
result_workers
</dt>
<dd>
<p>
Enable or disable result worker thread. The default is one, but
you can set it to zero to disabled result workers, for example
if you only want to export performance data.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>result_workers=0</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
perfdata
</dt>
<dd>
<p>
Defines if the module should distribute perfdata to gearman.
Can be specified multiple times and accepts comma separated lists.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>perfdata=yes</code></pre>
</div></div>
</div></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">processing of perfdata is not part of mod_gearman. You will need
additional worker for handling performance data. For example:
<a href="http://www.pnp4nagios.org">PNP4Nagios</a>. Performance data is just
written to the gearman queue.</td>
</tr></table>
</div>
<div class="dlist"><dl>
<dt class="hdlist1">
perfdata_send_all
</dt>
<dd>
<p>
Set <em>perfdata_send_all=yes</em> to submit all performance data
of all hosts and services regardless of if they
have <em>process_performance_data</em> enabled or not.
Default: <code>no</code>
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>perfdata_send_all=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
perfdata_mode
</dt>
<dd>
<p>
There will be only a single job for each host or service when putting
performance data onto the perfdata_queue in overwrite mode. In
append mode perfdata will be stored as long as there is memory
left. Setting this to <em>overwrite</em> helps preventing the perf_data
queue from getting to big. Monitor your perfdata carefully when
using the <em>append</em> mode.
Possible values are:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<code>1</code> - overwrite
</p>
</li>
<li>
<p>
<code>2</code> - append
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Default is 1.</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>perfdata_mode=1</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
result_queue
</dt>
<dd>
<p>
sets the result queue. Necessary when putting jobs from several Naemon instances
onto the same gearman queues. Default: <code>check_results</code>
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>result_queue=check_results_naemon1</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
orphan_host_checks
</dt>
<dd>
<p>
The Mod-Gearman NEB module will submit a fake result for orphaned host
checks with a message saying there is no worker running for this
queue. Use this option to get better reporting results, otherwise your
hosts will keep their last state as long as there is no worker
running.
Default is yes.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>orphan_host_checks=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
orphan_service_checks
</dt>
<dd>
<p>
Same like <em>orphan_host_checks</em> but for services.
Default is yes.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>orphan_service_checks=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
orphan_return
</dt>
<dd>
<p>
Set return code of orphaned checks.
Possible values are:
</p>
<div class="openblock">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<code>0</code> - OK
</p>
</li>
<li>
<p>
<code>1</code> - WARNING
</p>
</li>
<li>
<p>
<code>2</code> - CRITICAL
</p>
</li>
<li>
<p>
<code>3</code> - UNKNOWN
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Default is 2.</p></div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>orphan_return=2</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
accept_clear_results
</dt>
<dd>
<p>
When enabled, the NEB module will accept unencrypted results too. This
is quite useful if you have lots of passive checks and make use of
send_gearman/send_multi where you would have to spread the shared key
to all clients using these tools.
Default is no.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>accept_clear_results=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
latency_flatten_window
</dt>
<dd>
<p>
When enabled, reschedules host/service checks if their latency is more than
one second. This value is the maximum delay in seconds applied to hosts/services.
Set to 0 or less than 0 to disable rescheduling.
Default is 30.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>latency_flatten_window=30</code></pre>
</div></div>
</div></div>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_worker_options">Worker Options</h3>
<div class="paragraph"><p>Additional options for worker:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
identifier
</dt>
<dd>
<p>
Identifier for this worker. Will be used for the <em>worker_identifier</em> queue for
status requests. You may want to change it if you are using more than one worker
on a single host.  Defaults to the current hostname.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>identifier=hostname_test</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
pidfile
</dt>
<dd>
<p>
Path to the pidfile.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>pidfile=/path/to/pid.file</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
job_timeout
</dt>
<dd>
<p>
Default job timeout in seconds. Currently this value is only used for
eventhandler. The worker will use the values from the core for host
and service checks.
Default: 60
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>job_timeout=60</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
max-age
</dt>
<dd>
<p>
Threshold for discarding too old jobs. When a new job is older than
this amount of seconds it will not be executed and just discarded.
This will result in a message like "(Could Not Start Check In Time)".
Possible reasons for this are time differences between core and
worker (use NTP!) or the smart rescheduler of the core which should be
disabled. Set to zero to disable this check.
Default: 0
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>max-age=600</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
min-worker
</dt>
<dd>
<p>
Minimum number of worker processes which should run at any time. Default: 1
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>min-worker=1</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
max-worker
</dt>
<dd>
<p>
Maximum number of worker processes which should run at any time. You may set
this equal to min-worker setting to disable dynamic starting of workers. When
setting this to 1, all services from this worker will be executed one after
another. Default: 20
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>max-worker=20</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
spawn-rate
</dt>
<dd>
<p>
Defines the rate of spawned worker per second as long as there are jobs
waiting. Default: 1
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>spawn-rate=1</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
load_limit1
</dt>
<dd>
<p>
Set a limit based on the 1min load average. When exceding the load limit,
no new worker will be started until the current load is below the limit.
No limit will be used when set to 0.
Default: no limit
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>load_limit1=0</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
load_limit5
</dt>
<dd>
<p>
Set a limit based on the 5min load average. See <em>load_limit1</em> for details.
Default: no limit
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>load_limit5=0</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
load_limit15
</dt>
<dd>
<p>
Set a limit based on the 15min load average. See <em>load_limit1</em> for details.
Default: no limit
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>load_limit15=0</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
idle-timeout
</dt>
<dd>
<p>
Time in seconds after which an idling worker exits. This parameter
controls how fast your waiting workers will exit if there are no jobs
waiting. Set to 0 to disable the idle timeout. Default: 10
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>idle-timeout=30</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
max-jobs
</dt>
<dd>
<p>
Controls the amount of jobs a worker will do before he exits. Use this to
control how fast the amount of workers will go down after high load times.
Disabled when set to 0. Default: 1000
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>max-jobs=500</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
fork_on_exec
</dt>
<dd>
<p>
Use this option to disable an extra fork for each plugin execution.
Disabling this option will reduce the load on the worker host, but may
cause trouble with unclean plugins. Default: no
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>fork_on_exec=no</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
dupserver
</dt>
<dd>
<p>
sets the address of gearman job server where duplicated result will be sent to.
Can be specified more than once to add more server. Useful for duplicating
results for a reporting installation or remote gui.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>dupserver=logserver:4730,logserver2:4730</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
show_error_output
</dt>
<dd>
<p>
Use this option to show stderr output of plugins too. When set to no,
only stdout will be displayed.
Default is yes.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>show_error_output=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
timeout_return
</dt>
<dd>
<p>
Defines the return code for timed out checks. Accepted return codes
are 0 (Ok), 1 (Warning), 2 (Critical) and 3 (Unknown)
Default: 2
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>timeout_return=2</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
dup_results_are_passive
</dt>
<dd>
<p>
Use this option to set if the duplicate result send to the <em>dupserver</em>
will be passive or active.
Default is yes (passive).
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>dup_results_are_passive=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
debug-result
</dt>
<dd>
<p>
When enabled, the hostname of the executing worker will be put in
front of the plugin output. This may help with debugging your plugin
results.
Default is off.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>debug-result=yes</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
enable_embedded_perl
</dt>
<dd>
<p>
When embedded perl has been compiled in, you can use this
switch to enable or disable the embedded perl interpreter.
See <a href="#_embedded_perl">Embedded Perl</a> for details on EPN.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>enable_embedded_perl=on</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
use_embedded_perl_implicitly
</dt>
<dd>
<p>
Default value used when the perl script does not have a
"naemon: +epn" or "naemon: -epn" set.
Perl scripts not written for epn support usually fail with epn,
so its better to set the default to off.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>use_embedded_perl_implicitly=off</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
use_perl_cache
</dt>
<dd>
<p>
Cache compiled perl scripts. This makes the worker process a little
bit bigger but makes execution of perl scripts even faster.
When turned off, Mod-Gearman will still use the embedded perl
interpreter, but will not cache the compiled script.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>use_perl_cache=on</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
restrict_path
</dt>
<dd>
<p>
&#8216;restrict_path` allows you to restrict this worker to only execute plugins
from these particular folders. Can be used multiple times to specify more
than one folder.
Note that when this restriction is active, no shell will be spawned and
no shell characters ($&amp;();&lt;&gt;`"&#8217;|) are allowed in the command line itself.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>restrict_path=/usr/local/plugins/</code></pre>
</div></div>
</div></div>
</dd>
<dt class="hdlist1">
workaround_rc_25
</dt>
<dd>
<p>
Duplicate jobs from gearmand result sometimes in exit code 25 of
plugins because they are executed twice and get killed because of
using the same ressource. Sending results (when exit code is 25 )
will be skipped with this enabled.
Only needed if you experience problems with plugins exiting with exit
code 25 randomly. Default is off.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>workaround_rc_25=off</code></pre>
</div></div>
</div></div>
</dd>
</dl></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_queue_names">Queue Names</h2>
<div class="sectionbody">
<div class="paragraph"><p>You may want to watch your gearman server job queue. The shipped
gearman_top does this. It polls the gearman server every second
and displays the current queue statistics.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+-----------------------+--------+-------+-------+---------+
| Name                  | Worker | Avail | Queue | Running |
+-----------------------+--------+-------+-------+---------+
| check_results         | 1      | 1     | 0     | 0       |
| host                  | 3      | 3     | 0     | 0       |
| service               | 3      | 3     | 0     | 0       |
| eventhandler          | 3      | 3     | 0     | 0       |
| servicegroup_jmx4perl | 3      | 3     | 0     | 0       |
| hostgroup_japan       | 3      | 3     | 0     | 0       |
+-----------------------+--------+-------+-------+---------+</code></pre>
</div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
check_results
</dt>
<dd>
<p>
this queue is monitored by the neb module to fetch results from the
worker. You don&#8217;t need an extra worker for this queue. The number of
result workers can be set to a maximum of 256, but usually one is
enough. One worker is capable of processing several thousand results
per second.
</p>
</dd>
<dt class="hdlist1">
host
</dt>
<dd>
<p>
This is the queue for generic host checks. If you enable host checks
with the hosts=yes switch. Before a host goes into this queue, it is
checked if any of the local groups matches or a seperate hostgroup
machtes. If nothing matches, then this queue is used.
</p>
</dd>
<dt class="hdlist1">
service
</dt>
<dd>
<p>
This is the queue for generic service checks. If you enable service
checks with the <code>services=yes</code> switch. Before a service goes into this
queue it is checked against the local host- and service-groups. Then
the normal host- and servicegroups are checked and if none matches,
this queue is used.
</p>
</dd>
<dt class="hdlist1">
hostgroup_&lt;name&gt;
</dt>
<dd>
<p>
This queue is created for every hostgroup which has been defined by
the hostgroups=&#8230; option. Make sure you have at least one worker for
every hostgroup you specify. Start the worker with <code>--hostgroups=...</code>
to work on hostgroup queues. Note that this queue may also contain
service checks if the hostgroup of a service matches.
</p>
</dd>
<dt class="hdlist1">
servicegroup_&lt;name&gt;
</dt>
<dd>
<p>
This queue is created for every servicegroup which has been defined by
the <code>servicegroup=...</code> option.
</p>
</dd>
<dt class="hdlist1">
eventhandler
</dt>
<dd>
<p>
This is the generic queue for all eventhandler. Make sure you have a
worker for this queue if you have eventhandler enabled. Start the
worker with <code>--events</code> to work on this queue.
</p>
</dd>
<dt class="hdlist1">
perfdata
</dt>
<dd>
<p>
This is the generic queue for all performance data. It is created and
used if you switch on <code>--perfdata=yes</code>. Performance data cannot be
processed by the gearman worker itself. You will need
<a href="http://www.pnp4nagios.org">PNP4Nagios</a> therefor.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_performance">Performance</h2>
<div class="sectionbody">
<div class="paragraph"><p>While the main motivation was to ease distributed configuration, this
plugin also helps to spread the load on multiple worker. Throughput is
mainly limited by the amount of jobs a single Naemon instance can put
onto the Gearman job server. Keep the Gearman job server close to the
Naemon box. Best practice is to put both on the same machine. Both
processes will utilize one core. Some testing with my workstation
(Dual Core 2.50GHz) and two worker boxes gave me these results. I used
a sample Nagios installation with 20.000 Services at a 1 minute
interval and a sample plugin which returns just a single line of
output. I got over 300 Servicechecks per second, which means you could
easily setup 100.000 services at a 5 minute interval with a single
Nagios box. The amount of worker boxes depends on your check types.</p></div>
<a title="mod gearman performance" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/mod_gearman_performance_2.png"><img src="http://labs.consol.de/nagios/mod-gearman/mod_gearman_performance_2.png" alt="mod_gearman performance" width="473" height="122" style="float:none" /></a>
<a title="mod gearman performance" rel="lightbox[mod_gm]" href="http://labs.consol.de/nagios/mod-gearman/mod_gearman_performance_1.png"><img src="http://labs.consol.de/nagios/mod-gearman/mod_gearman_performance_1.png" alt="mod_gearman performance" width="424" height="176" style="float:none" /></a>
<div class="paragraph"><p>See this article about benchmarks with <a href="https://labs.consol.de/mod-gearman/nagios/omd/2012/10/23/monitoring-core-benchmarks.html">Nagios3, Nagios4 and Mod-Gearman</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_exports">Exports</h2>
<div class="sectionbody">
<div class="paragraph"><p>Exports export data structures from the Naemon core as JSON data. For
each configurable event one job will be created. At the moment, the
only useful event type is the logdata event which allows you to create
a json data job for every logged line. This can be very useful for
external reporting tools.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
exports
</dt>
<dd>
<p>
Set the queue name to create the jobs in. The return code will be sent
back to the core (Not all callbacks support return codes). Callbacks
are a list of callbacks for which you want to export json data.
</p>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre><code>export=&lt;queue&gt;:&lt;returncode&gt;:&lt;callback&gt;[,&lt;callback&gt;,...]</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>export=log_queue:1:NEBCALLBACK_LOG_DATA</code></pre>
</div></div>
</div></div>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_embedded_perl">Embedded Perl</h2>
<div class="sectionbody">
<div class="paragraph"><p>Since 1.2.0 Mod-Gearman has builtin embedded Perl support which means
generally a big performance boost when you have lots of perl plugins.</p></div>
<div class="paragraph"><p>To enable embedded Perl you need to run configure with
--enable-embedded-perl</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  ./configure --enable-embedded-perl otheroptions...</code></pre>
</div></div>
<div class="paragraph"><p>The --with-perlcache configure option has been replace by a runtime
configure option <em>use_perl_cache</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Not all perl plugins support EPN. You can fix them, add <em>#
naemon: -epn</em> in the first 10 lines of the script or set
<em>use_embedded_perl_implicitly=off</em> so all scripts without the explicit
tag are run without embedded Perl.</td>
</tr></table>
</div>
<div class="paragraph"><p>The default configuration of Mod-Gearman enables embedded Perl, but
only uses it for Perl scripts which explicitly set <em># naemon: +epn</em>.
This is a very safe way of using embedded Perl but you probably miss
some plugins which do not set the header and still would run with EPN.
You may want to use the <em>mini_epn</em> from your Naemon installation to
verify if a plugin works with EPN or not.</p></div>
<div class="paragraph"><p>General EPN documentation is valid for Mod-Gearman as well:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://www.naemon.io/documentation/usersguide/embeddedperl.html">Embedded Perl</a>
</p>
</li>
<li>
<p>
<a href="https://www.naemon.io/documentation/usersguide/epnplugins.html">Plugin Guidelines</a>
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Mod-Gearman does not fix all of the memory leaks introduced with
Naemon and Embedded Perl, but it moves the leaks away from the core.
And they do not affect Mod-Gearman at all, as they are only in the
preforked worker processes which will be restarted automatically from
time to time (see <em>max-jobs</em>).</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to">How To</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_how_to_monitor_job_server_and_worker">How to Monitor Job Server and Worker</h3>
<div class="paragraph"><p>Use the supplied check_gearman to monitor your worker and job server.
Worker have a own queue for status requests.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%&gt; ./check_gearman -H &lt;job server hostname&gt; -q worker_&lt;worker hostname&gt; -t 10 -s check
check_gearman OK - localhost has 10 worker and is working on 1 jobs|worker=10 running=1 total_jobs_done=1508</code></pre>
</div></div>
<div class="paragraph"><p>This will send a test job to the given job server and the worker will
respond with some statistical data.</p></div>
<div class="paragraph"><p>Job server can be monitored with:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%&gt; ./check_gearman -H localhost -t 20
check_gearman OK - 6 jobs running and 0 jobs waiting.|check_results=0;0;1;10;100 host=0;0;9;10;100 service=0;6;9;10;100</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_how_to_submit_passive_checks">How to Submit Passive Checks</h3>
<div class="paragraph"><p>You can use send_gearman to submit active and passive checks to a
gearman job server where they will be processed just like a finished
check would do.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%&gt; ./send_gearman --server=&lt;job server&gt; --encryption=no --host="&lt;hostname&gt;" --service="&lt;service&gt;" --message="message"</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_how_to_build_send_gearman_exe">How to build send_gearman.exe</h3>
<div class="paragraph"><p>After installing strawberry perl, you need to install the
<em>PAR::Packer</em> module and run pp:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  pp -l zlib1__.dll -l ssleay32__.dll -l libeay32__.dll -x -z 9 -o send_gearman.exe send_gearman.pl</code></pre>
</div></div>
<div class="paragraph"><p>Or just use the prebuild one from labs.consol.de:
<a href="http://mod-gearman.org/archive/send_gearman.zip">send_gearman.exe</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_submit_check_multi_results">How to Submit check_multi Results</h3>
<div class="paragraph"><p>check_multi is a plugin which executes multiple child checks.
See more details about the feed_passive mode at:
<a href="http://www.my-plugin.de/wiki/projects/check_multi/feed_passive">www.my-plugin.de</a></p></div>
<div class="paragraph"><p>You can pass such child checks to Naemon via the mod_gearman
neb module:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%&gt; check_multi -f multi.cmd -r 256 | ./send_multi --server=&lt;job server&gt; --encryption=no --host="&lt;hostname&gt;" --service="&lt;service&gt;"</code></pre>
</div></div>
<div class="paragraph"><p>If you want to use only check_multi and no other workers, you can
achieve this with the following neb module settings:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>broker_module=/usr/local/share/naemon/mod_gearman_naemon.o server=localhost encryption=no eventhandler=no hosts=no services=no hostgroups=does_not_exist config=.../module.conf</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">encryption is not necessary if you both run the check_multi checks
and the Naemon check_results queue on the same server.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_set_queue_by_custom_variable">How to Set Queue by Custom Variable</h3>
<div class="paragraph"><p>Set <em>queue_custom_variable=worker</em> in your Mod-Gearman NEB
configuration. Then adjust your Naemon host/service configuration and
add the custom variable:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  define host {
    ...
    _WORKER    hostgroup_test
  }</code></pre>
</div></div>
<div class="paragraph"><p>The test hostgroup does not have to exist, it is a virtual queue name
which is used by the worker.</p></div>
<div class="paragraph"><p>Adjust your Mod-Gearman worker configuration and put <em>test</em> in the
<em>hostgroups</em> attribute. From then on, the worker will work on all jobs
in the <em>hostgroup_test</em> queue.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notifications">Notifications</h2>
<div class="sectionbody">
<div class="paragraph"><p>Starting with version 3.0.2 Mod-Gearman does distribute Notifications as well.
All Notifications (except bypassed by local groups) are send into the notifications
queue and processed from there.</p></div>
<div class="paragraph"><p>Mod-Gearman does not support environment macros, except two plugin output related
ones.</p></div>
<div class="paragraph"><p>It does set</p></div>
<div class="ulist"><ul>
<li>
<p>
NAGIOS_SERVICEOUTPUT
</p>
</li>
<li>
<p>
NAGIOS_LONGSERVICEOUTPUT
</p>
</li>
</ul></div>
<div class="paragraph"><p>for service notifications and</p></div>
<div class="ulist"><ul>
<li>
<p>
NAGIOS_HOSTOUTPUT
</p>
</li>
<li>
<p>
NAGIOS_LONGHOSTOUTPUT
</p>
</li>
</ul></div>
<div class="paragraph"><p>for host notifications.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_supported_dependencies">Supported Dependencies</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Mod-Gearman works best with libgearman/gearmand 0.33 and Naemon. If in
doubt, use these versions.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_lib_gearman">Lib-Gearman</h3>
<div class="paragraph"><p>Mod-Gearman has successfully been tested on the following Gearmand
Versions. It is recommended to always use the latest listed version of
libgearman.</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/gearman/gearmand/releases/tag/1.1.19.1">libgearman 1.1.19.1</a>
</p>
</li>
<li>
<p>
<a href="https://launchpad.net/gearmand/trunk/0.33">libgearman 0.33</a>
</p>
</li>
<li>
<p>
<a href="https://launchpad.net/gearmand/trunk/0.32">libgearman 0.32</a>
</p>
</li>
<li>
<p>
<a href="https://launchpad.net/gearmand/trunk/0.25">libgearman 0.25</a>
</p>
</li>
<li>
<p>
<a href="https://launchpad.net/gearmand/trunk/0.23">libgearman 0.23</a>
</p>
</li>
<li>
<p>
<a href="https://launchpad.net/gearmand/trunk/0.14">libgearman 0.14</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_naemon">Naemon</h3>
<div class="paragraph"><p>Mod-Gearman works perfectly with all versions of the Naemon core.</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://naemon.io">Naemon</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_nagios">Nagios</h3>
<div class="paragraph"><p>Mod-Gearman dropped support for Nagios 3 starting with Mod-Gearman
4.x. Use a 3.x release from the archive if you still need that.</p></div>
</div>
<div class="sect2">
<h3 id="_icinga">Icinga</h3>
<div class="paragraph"><p>Mod-Gearman dropped support for Icinga 1 starting with Mod-Gearman
4.x. Use a 3.x release from the archive if you still need that.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hints">Hints</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Make sure you have at least one worker for every queue. You should
   monitor that (check_gearman).
</p>
</li>
<li>
<p>
Add Logfile checks for your gearmand server and mod_gearman
   worker.
</p>
</li>
<li>
<p>
Make sure all gearman checks are in local groups. Gearman self
   checks should not be monitored through gearman.
</p>
</li>
<li>
<p>
Checks which write directly to the Naemon command file (ex.:
   check_mk) have to run on a local worker or have to be excluded by
   the localservicegroups.
</p>
</li>
<li>
<p>
Keep the gearmand server close to Naemon for better performance.
</p>
</li>
<li>
<p>
If you have some checks which should not run parallel, just setup a
   single worker with --max-worker=1 and they will be executed one
   after another. For example for cpu intesive checks with selenium.
</p>
</li>
<li>
<p>
Make sure all your worker have the Monitoring-Plugins available under
   the same path. Otherwise they could&#8217;nt be found by the worker.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-03-05 04:41:38 CET
</div>
</div>
</body>
</html>
